#### Promise

* 预期状态机：`Promise`对象有三种状态，当从pending**落定**状态后，无法再次更改。

  * 待定：pending。
  * 解决：resolved。
  * 拒绝：rejected。

  预期的状态是私有的，无法直接通过`Promise`对象访问。创建`Promise`对象时，接受两个可调用参数——`resolve`和`reject`，调用后将`Promise`对象落定到对应状态。调用这两个参数时，可以传入用于提供返回值的参数。

* Thenable接口：`Promise`实现了`then()`方法，可以接受`on_resolve和on_reject`两个可调用参数，当预期落定到对应状态时执行。

  ```js
  let pro = new Promise((resolve) => {
      resolve("hello");
  });
  
  pro.then((arg) => {
      console.log(arg);	// hello
  });
  ```

* `Promise.all()`将多个预期实例组合成一个新的预期，当所有预期都处于兑现后，新的预期将处于兑现。

  ```js
  let pro = Promise.all([
      new Promise((resolve) => {
          setTimeout(() => {
              console.log("stepA");
              resolve();
          }, 1000);
      }),
      new Promise((resolve) => {
          setTimeout(resolve, 1000);
          console.log("stepB");
      }),
  ]);
  
  pro.then(() => {
      console.log("final step");
  });
  
  // stepB
  // stepA
  // final step
  ```

  `Promise.race()`将多个预期合成一个预期，新预期的状态将被设置为第一个落定预期的状态。

---

#### 异步函数

* ES8引入关键字`async`、`await`，提高了异步代码的结构性。

* 使用`async`定义的函数都是异步的，可以用在函数声明、函数表达式、箭头函数和方法上。

  ```js
  // 函数声明
  async function as_func() {}
  // 函数表达式
  let as = async function () {};
  // 箭头函数
  let as_arror = async () => {};
  // 类方法
  class Async {
      async as_func() {}
  }
  ```

* 调用异步函数时，返回`Promise`对象，当函数结束后，该对象将落定到解决状态。

  ```js
  async function func() {}
  console.log(func() instanceof Promise);	// true
  ```

* 在异步函数中使用`await`关键字，暂停异步函数的执行，等待一个`Promise`对象解决。

  ```js
  async function as_func() {
      let pro = new Promise((resolve) => setTimeout(resolve, 1000));
      console.log(await pro);
  }
  
  as_func();	// undefined
  ```



* 异步函数中真正起作用的是`await`关键字，`async`只作为标识符。如果异步函数不包括`await`关键字，其和同步函数没有区别。

    ```js
    async function async_func() {
    while (true) console.log("async");
    }
    function sync_func() {
    while (true) console.log("sync");
    }
    
    // 阻塞在async_func()
    async_func();
    sync_func();
    ```
    
    所以即使`await`后跟一个立即可用的值，函数的剩余部分也会被异步求值。
    
    ```js
    async function async_fun(){
        console.log(2);
        await null;
        console.log(4);
    }
    
    console.log(1);
    async_fun();
    console.log(3);
    
    // 1
    // 2
    // 3
    // 4
    ```
    
* 实现`sleep`。

    ```js
    async function sleep(delay) {
        return new Promise((resolve) => setTimeout(resolve, delay));
    }
    
    async function async_func() {
        let begin = new Date();
        await sleep(1000);
        console.log(new Date() - begin);
    }
    
    async_func();	// 1024
    ```

    
