#### 元表

* 元表为一系列表数据定义了通用行为，每一个表对象都拥有元表，且新创建的表对象，其元表为`nil`。

  通过`getmetatable()`获取表对象的元表，通过`setmetatable()`设置表对象的元表。

* 元表本身就是一个表，表之间可以相互设置元表，任何配置都是合法的。

---

#### 原字段

* Lua中可以定义一系列元字段，作为对应操作时的运行逻辑。

  元字段除了定义为函数——元方法，还可以定义为其它数据类型。

  | 常用元字段                                                   | 说明                                                         |
  | ------------------------------------------------------------ | ------------------------------------------------------------ |
  | `__add = function(lhs,rhs) end`<br />`__sub = function(lhs,rhs) end`<br />`__mul = function(lhs,rhs) end` | 基本算数运算符                                               |
  | `__concat = function(lhs,rhs) end`                           | `..` 运算符                                                  |
  | `__eq = function(lhs,rhs) end`<br />`__lt = function(lhs,rhs) end`<br />`__le = function(lhs,rhs) end` | 基本比较运算符<br />只有这三个比较运算的原方法，<br />另外三个运算符通过取否取值 |
  | `__tostring = function(tab) end`                             | `tostring()`调用                                             |
  | `__metatable = {}`                                           | 调用`getmetatable()`时返回`__metatable`，<br />调用`setmetatable()`时报错 |
  | `__pairs = function(tab) end`                                | `pairs()`调用                                                |
  | `__index = function(tab,key) end`<br />`__index = {}`        | 访问表中不存在的字段时，<br />调用`__index(tab,key)`或访问`__index[key]`<br />可以通过`rawget()`绕过 |
  | `__newindex = function(tab,key,val) end`                     | 对表中不存在的字段赋值时调用<br />可以通过`rawset()`绕过     |
  | `__len = function(tab)`                                      | `#`运算符                                                    |

* 当运算符作用于两个对象时，元方法选择模式：

  * 当只有一个操作对象的元表有效时，调用该对象的元方法。
  * 当两个操作数的元表均有效时，调用左边操作对象的元方法。

* 通过代理实现只读的表：

  ```lua
  function SetReadOnly(tab)
      local proxy = {} -- 通过proxy代理访问tab
      setmetatable(proxy, {
          __index = tab,
          __newindex = function()
              error("attempt to update read-only table")
          end
      })
      return proxy
  end
  ```



