#### 函数定义

* Lua中的所有函数都是匿名的，任何定义方式得到的都是一个指向函数的变量。

  ```lua
  function func_1() end
  func_1 = function() end
  
  local function func_2() end
  func_2 = function() end
  ```

---

#### 参数

* 调用函数时传递的参数不必和函数定义时形参数量匹配，Lua将抛弃多余的参数，以`nil`补齐不足的参数。

* 默认实参：Lua没有提供默认实参的实现，但可以通过判断参数以设置默认实参。

  ```lua
  local function func(n)
      if n == nil then n = 0 end	-- 默认参数为0
  end
  ```

* 在调用函数时，如果只传入一个参数，且参数是字符串或表类型字面量时，可以忽略`()`。

  ```lua
  print "hello world"
  print {"table","expr"}
  ```

* 可变长参数：参数列表中使用 `...` 以表示接受任意数量的参数，且在函数内部还可以使用 `...` 将参数传递给其它函数，或使用多种方式解析参数列表：

  * 多重赋值。

    ```lua
    local function func(...)
        local a, b, c = ...
    end
    ```

  * 使用`ipairs()`——如果传入参数中包含`nil`，将遍历无效的序列。

    ```lua
    local function func(...)
        for _, v in ipairs({ ... }) do
            print(v)  -- 1 2 3 4
        end
    end
    
    func(1, 2, 3, 4, nil, 5)
    ```

  * 使用`table.pack()`。

    ```lua
    local function func(...)
        local tab = table.pack(...)
        for i = 1,#tab do
            print(tab[i])   -- 1 2 3 4 nil 5
        end
    
    end
    
    func(1, 2, 3, 4, nil, 5)
    ```

  * 使用`select()`函数。

    ```lua
    local function func(...)
        for i = 1, select("#", ...) do
            local arg = select(i, ...)  -- 只会得到一个参数
            print(arg)  -- 1 2 3 4 nil 5
        end
    end
    
    func(1, 2, 3, 4, nil, 5)
    ```

    | `select()`调用参数  | 说明                                         |
    | ------------------- | -------------------------------------------- |
    | `select(n , ...)`   | n是一个数值，返回序列中索引n之后的所有参数。 |
    | `select("#" , ...)` | 返回 `...` 中参数数量。                      |

---

#### 返回值

* Lua函数可以一次返回多个返回值，并在不同的表达式中，其返回值被不同的处理。
  * 函数调用作为单独语句出现时，所有返回值直接被抛弃。
  * 当函数调用作用于某些表达式时，如数值运算，只保留第一个返回值。
  * 当函数调用是**一系列表达式[^1]**中最后一个、或唯一一个时，才可能获取所有返回值。
* 尾调用优化：如果`return`后的唯一表达式是函数调用，那么Lua会先清空当前栈，再进行函数调用。

---

#### 闭包

* 词法定界：在代码块内部定义新函数时，新函数可以使用同名的局部变量访问外部的局部变量，且会延长外部局部变量的生命周期。

  闭包中可操作的同名局部变量，称为上值——upvalue。







[^1]:一系列表达式包括：多重赋值、实参列表、表构造器和`return`语句。
